# glb-compressor

Multi-phase GLB/glTF 3D model compression toolkit. CLI (`glb-compressor`), HTTP
server (`glb-server`), and library API.

AGENTS.md and CLAUDE.md are symlinks to this file (`.rules`).

## Structure

```text
lib/            Core library (public API barrel: mod.ts)
  compress.ts   5-phase compression pipeline orchestrator
  transforms.ts Custom glTF-Transform transforms (geometry, animation, weights)
  constants.ts  Shared constants and error codes
  utils.ts      Utility functions
cli/main.ts     CLI entry point (bin: glb-compressor)
server/main.ts  HTTP server entry point (bin: glb-server)
build/          Build infra (NOT output) — Bun polyfill plugin + Node.js shims
build.ts        3-target build script (Node ESM, Bun ESM, Bun bytecode)
bench.ts        Compression benchmark runner (dev-only)
```

## Where to look

| Task                   | Location                      |
| ---------------------- | ----------------------------- |
| Add/change compression | `lib/compress.ts`             |
| Add glTF transform     | `lib/transforms.ts`           |
| Change presets         | `lib/compress.ts` → `PRESETS` |
| Add CLI flag           | `cli/main.ts`                 |
| Add server endpoint    | `server/main.ts`              |
| Fix Node.js compat     | `build/polyfills.ts`          |
| Change build targets   | `build.ts`                    |
| Public API surface     | `lib/mod.ts` (barrel)         |

## Architecture

- **Dual-runtime**: written against Bun APIs, compiled to Node.js via polyfill
  layer. `package.json` exports use conditional `"bun"` vs `"node"` fields.
- **Skinned-model-aware**: pipeline detects skinned meshes and skips transforms
  that break skeleton hierarchies (flatten, join, weld, mergeByDistance,
  reorder, quantize).
- **gltfpack-first**: prefers external `gltfpack` binary; falls back to meshopt
  WASM if unavailable.
- **WASM pre-warm**: Draco + Meshopt WASM initialized eagerly at module load.
- Path aliases: `$lib/*`, `$cli/*`, `$server/*`, `$models`, `pkg`
  (package.json).

## Conventions

- **Bun-first** — always prefer Bun APIs over Node.js equivalents.
- **Tabs**, single quotes, 80-char line width.
- **Strict TypeScript** — `strict: true`, `noUncheckedIndexedAccess`,
  `verbatimModuleSyntax` (use `import type` for type-only imports).
- **Biome** for linting, **dprint** for formatting (`bun run fmt`).
- **Type checker**: `tsgo` (`bun run typecheck`), not `tsc`.
- Import organization automated by Biome except in barrel/entry files (`mod.ts`,
  `index.ts`, `main.ts`).
- Exact dependency versions (`bunfig.toml`: `install.exact = true`).

## Anti-patterns

- Don't use npm/yarn/pnpm — use `bun`.
- Don't use express — use `Bun.serve()`.
- Don't use dotenv — Bun auto-loads `.env`.
- Don't use `node:fs` readFile/writeFile — use `Bun.file` / `Bun.write`.
- Don't use execa — use `Bun.$`.
- No `any`, no `!` non-null assertions, no `as Type` casts.
- Don't flatten/join/weld/quantize skinned models.

## Commands

```sh
bun run dev         # Hot-reload server
bun run cli         # Run CLI from source
bun run check       # Biome lint + format check
bun run lint        # Biome lint only
bun run fmt         # dprint format
bun run typecheck   # tsgo type check
bun build.ts        # Multi-target build
bun test            # Run tests (bun:test)
```

## Build targets

| Target       | Output               | Format       | Notes                    |
| ------------ | -------------------- | ------------ | ------------------------ |
| Node.js      | `dist/node/`         | ESM          | Polyfilled, not minified |
| Bun          | `dist/bun/`          | ESM          | Minified                 |
| Bun bytecode | `dist/bun-bytecode/` | CJS + `.jsc` | Minified, no sourcemaps  |
| Types        | `dist/types/`        | `.d.ts`      | Via tsgo                 |

Externals (never bundled): `sharp`, `draco3dgltf`, `meshoptimizer`.

## Notes

- `server/main.ts` guards startup with `import.meta.main` — safe to import as
  library.
- Dockerfile builds gltfpack from source with BasisU support; CMD references
  `./dist/index.js` but build produces `./dist/main.cjs` — potential mismatch.
- No tests exist yet. Intended framework: `bun:test`.
- `models/` dir (gitignored) contains `.glb` fixtures for benchmarking.
