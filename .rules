# glb-compressor

Multi-phase GLB/glTF 3D model compression toolkit. CLI (`glb-compressor`), HTTP
server (`glb-server`), and library API.

AGENTS.md and CLAUDE.md are symlinks to this file (`.rules`).

## Structure

```text
lib/            Core library (public API barrel: mod.ts)
  compress.ts   5-phase compression pipeline orchestrator
  transforms.ts Custom glTF-Transform transforms (geometry, animation, weights)
  constants.ts  Shared constants and error codes
  utils.ts      Utility functions
cli/main.ts     CLI entry point (bin: glb-compressor)
server/main.ts  HTTP server entry point (bin: glb-server)
build/          Build infra (NOT output) — Bun polyfill plugin + Node.js shims
build.ts        3-target build script (Node ESM, Bun ESM, Bun bytecode)
bench.ts        Compression benchmark runner (dev-only)
```

## Where to look

| Task                   | Location                      |
| ---------------------- | ----------------------------- |
| Add/change compression | `lib/compress.ts`             |
| Add glTF transform     | `lib/transforms.ts`           |
| Change presets         | `lib/compress.ts` → `PRESETS` |
| Add CLI flag           | `cli/main.ts`                 |
| Add server endpoint    | `server/main.ts`              |
| Fix Node.js compat     | `build/polyfills.ts`          |
| Change build targets   | `build.ts`                    |
| Public API surface     | `lib/mod.ts` (barrel)         |

## Architecture

- **Dual-runtime**: written against Bun APIs, compiled to Node.js via polyfill
  layer. `package.json` exports use conditional `"bun"` vs `"node"` fields.
- **Skinned-model-aware**: pipeline detects skinned meshes and skips transforms
  that break skeleton hierarchies (flatten, join, weld, mergeByDistance,
  reorder, quantize).
- **gltfpack-first**: prefers external `gltfpack` binary; falls back to meshopt
  WASM if unavailable.
- **WASM pre-warm**: Draco + Meshopt WASM initialized eagerly at module load.
- Path aliases: `$lib/*`, `$cli/*`, `$server/*`, `$models`, `pkg`
  (package.json).

## Conventions

- **Bun-first** — always prefer Bun APIs over Node.js equivalents.
- **Tabs**, single quotes, 80-char line width.
- **Strict TypeScript** — `strict: true`, `noUncheckedIndexedAccess`,
  `verbatimModuleSyntax` (use `import type` for type-only imports).
- **Biome** for linting, **dprint** for formatting (`bun run fmt`).
- **Type checker**: `tsgo` (`bun run typecheck`), not `tsc`.
- Import organization automated by Biome except in barrel/entry files (`mod.ts`,
  `index.ts`, `main.ts`).
- Exact dependency versions (`bunfig.toml`: `install.exact = true`).

## Anti-patterns

- Don't use npm/yarn/pnpm — use `bun`.
- Don't use express — use `Bun.serve()`.
- Don't use dotenv — Bun auto-loads `.env`.
- Don't use `node:fs` readFile/writeFile — use `Bun.file` / `Bun.write`.
- Don't use execa — use `Bun.$`.
- No `any`, no `!` non-null assertions, no `as Type` casts.
- Don't flatten/join/weld/quantize skinned models.

## Commands

```sh
bun run dev         # Hot-reload server
bun run cli         # Run CLI from source
bun run check       # Biome lint + format check
bun run lint        # Biome lint only
bun run fmt         # dprint format
bun run typecheck   # tsgo type check
bun build.ts        # Multi-target build
bun test            # Run tests (bun:test)
```

## Build targets

| Target       | Output               | Format       | Notes                    |
| ------------ | -------------------- | ------------ | ------------------------ |
| Node.js      | `dist/node/`         | ESM          | Polyfilled, not minified |
| Bun          | `dist/bun/`          | ESM          | Minified                 |
| Bun bytecode | `dist/bun-bytecode/` | CJS + `.jsc` | Minified, no sourcemaps  |
| Types        | `dist/types/`        | `.d.ts`      | Via tsgo                 |

Externals (never bundled): `sharp`, `draco3dgltf`, `meshoptimizer`.

## Skills

Agent skills in `skills/` following the [Agent Skills](https://agentskills.io/)
format. Each skill is a self-contained package with a `SKILL.md` frontmatter
definition and optional reference files.

| Skill                    | Purpose                               | References                |
| ------------------------ | ------------------------------------- | ------------------------- |
| `glb-compressor-cli`     | CLI usage, flags, presets, examples   | —                         |
| `glb-compressor-library` | Programmatic API, types, pipeline     | `api.md`, `transforms.md` |
| `glb-compressor-server`  | HTTP endpoints, SSE streaming, errors | —                         |

### Structure

```text
skills/
  glb-compressor-cli/
    SKILL.md              # CLI binary, options, presets, pipeline phases
  glb-compressor-library/
    SKILL.md              # compress(), init(), types, presets, anti-patterns
    references/
      api.md              # Full type surface: CompressOptions, CompressResult,
                          # constants, ErrorCode, utility functions, PRESETS
      transforms.md       # Custom Transform functions for a-la-carte use,
                          # safety matrix (static vs skinned)
  glb-compressor-server/
    SKILL.md              # Endpoints, SSE events, error codes, CORS, limits
```

### Installing skills (for users)

Install via the [`skills` CLI](https://github.com/vercel-labs/skills) (works
with 35+ agents including Claude Code, Cursor, Codex, OpenCode, Copilot):

```sh
# Install all glb-compressor skills
npx skills add kjanat/glb-compressor

# Install a specific skill only
npx skills add kjanat/glb-compressor --skill glb-compressor-cli

# Install globally (available across all projects)
npx skills add kjanat/glb-compressor -g

# Install to specific agents
npx skills add kjanat/glb-compressor -a claude-code -a cursor

# List available skills without installing
npx skills add kjanat/glb-compressor --list
```

Manual installation (any agent):

```sh
# Claude Code
cp -r skills/glb-compressor-cli ~/.claude/skills/

# Cursor
cp -r skills/glb-compressor-cli ~/.cursor/skills/

# OpenCode
cp -r skills/glb-compressor-cli ~/.config/opencode/skills/

# Project-local (committed with repo, shared with team)
cp -r skills/glb-compressor-cli .claude/skills/
```

### Skill conventions

- `SKILL.md` frontmatter: `name`, `description` (with trigger phrases),
  `license`, `compatibility`, optional `references` list.
- Reference files linked from SKILL.md via `references:` frontmatter field.
- Skills are read-only documentation — no scripts, no build step.
- Keep SKILL.md < 500 lines; put detailed reference in separate files.

### When to update skills

- **Add/change CLI flag** → update `glb-compressor-cli/SKILL.md`
- **Add/change API export** → update `glb-compressor-library/SKILL.md` +
  `references/api.md`
- **Add/change transform** → update `references/transforms.md` (safety matrix)
- **Add/change endpoint** → update `glb-compressor-server/SKILL.md`
- **Add/change preset** → update all three skills (CLI, library, server)
- **Add/change constant** → update `references/api.md`

## Notes

- `server/main.ts` guards startup with `import.meta.main` — safe to import as
  library.
- Dockerfile builds gltfpack from source with BasisU support; CMD references
  `./dist/index.js` but build produces `./dist/main.cjs` — potential mismatch.
- No tests exist yet. Intended framework: `bun:test`.
- `models/` dir (gitignored) contains `.glb` fixtures for benchmarking.
